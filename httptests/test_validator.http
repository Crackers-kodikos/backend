### ========================================
### VALIDATOR OPERATIONS - HTTP TESTS
### ========================================
### Complete Validator Workflow Testing
### Base URL: http://localhost:3232
### ========================================

@baseUrl = http://localhost:3232
@validatorToken = 
@workshopToken = 
@tailorToken = 
@tailorId = 1
@itemId = 1

### ========================================
### PHASE 0: SETUP - Create Test Data
### ========================================

### SETUP-1: Register Workshop Owner
POST {{baseUrl}}/api/auth/register/workshop
Content-Type: application/json

{
  "username": "validator_workshop_1",
  "password": "SecurePass123!",
  "email": "validator_workshop@test.com",
  "firstname": "Ahmed",
  "lastname": "Mohamed",
  "workshopName": "Validator Test Workshop",
  "workshopDescription": "Testing validator operations",
  "workshopAddress": "123 Validator St",
  "phone": "+213600000001"
}

### SETUP-2: Get Tailor Referral Link
# Use workshop token from SETUP-1
POST {{baseUrl}}/api/referral/tailor
Authorization: Bearer <workshop_token_from_setup1>
Content-Type: application/json

{
  "expiresInDays": 30
}

### SETUP-3: Register Tailor
# Use referral from SETUP-2
POST {{baseUrl}}/api/auth/register/user
Content-Type: application/json

{
  "username": "tailor_test_1",
  "password": "SecurePass123!",
  "email": "tailor@test.com",
  "firstname": "Zainab",
  "lastname": "Hassan",
  "phone": "+213600000002",
  "userType": "TAILOR",
  "referralCode": "<referral_from_setup2>"
}

### SETUP-4: Get Validator Referral Link
POST {{baseUrl}}/api/referral/validator
Authorization: Bearer <workshop_token_from_setup1>
Content-Type: application/json

{
  "expiresInDays": 30
}

### SETUP-5: Register Validator
# Use referral from SETUP-4
# Copy token and set @validatorToken
POST {{baseUrl}}/api/auth/register/user
Content-Type: application/json

{
  "username": "validator_test_1",
  "password": "SecurePass123!",
  "email": "validator@test.com",
  "firstname": "Ibrahim",
  "lastname": "Hassan",
  "phone": "+213600000003",
  "userType": "VALIDATOR",
  "referralCode": "<referral_from_setup4>"
}

### SETUP-6: Login Validator
# Copy accessToken and set @validatorToken
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "username": "validator_test_1",
  "password": "SecurePass123!"
}

### SETUP-7: Get Magazine Referral
POST {{baseUrl}}/api/referral/magazine
Authorization: Bearer <workshop_token_from_setup1>
Content-Type: application/json

{
  "expiresInDays": 30
}

### SETUP-8: Register Magazine
# Use referral from SETUP-7
POST {{baseUrl}}/api/auth/register/user
Content-Type: application/json

{
  "username": "magazine_validator_test_1",
  "password": "SecurePass123!",
  "email": "magazine_validator@test.com",
  "firstname": "Fatima",
  "lastname": "Ali",
  "phone": "+213600000004",
  "userType": "MAGAZINE_OWNER",
  "referralCode": "<referral_from_setup7>"
}

### SETUP-9: Create Order
# Login magazine and create order
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "username": "magazine_validator_test_1",
  "password": "SecurePass123!"
}

### SETUP-10: Create Order with Items
# Use magazine token from SETUP-9
# Workshop ID should be 1 (from setup)
POST {{baseUrl}}/api/magazine/orders
Authorization: Bearer <magazine_token_from_setup9>
Content-Type: application/json

{
  "workshopId": 1,
  "orderNumber": "VALIDATOR-TEST-001",
  "description": "Women's dresses for validator testing",
  "totalPrice": 1500.00,
  "items": [
    {
      "description": "Red silk dress"
    },
    {
      "description": "Blue cotton dress"
    }
  ]
}

### SETUP-11: Validate Order
# Use validator token from SETUP-6
# Order ID from SETUP-10 response
POST {{baseUrl}}/api/orders/<orderId_from_setup10>/validate
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "notes": "Order validated. Ready for item assignment."
}

### SETUP-12: Get Tailor ID
# Use validator token
GET {{baseUrl}}/api/validator/tailors
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 1: PROFILE MANAGEMENT
### ========================================

### 1.1 - Get Validator Profile
GET {{baseUrl}}/api/validator/profile
Authorization: Bearer {{validatorToken}}

### 1.2 - Update Validator Profile
PUT {{baseUrl}}/api/validator/profile
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "fullName": "Ibrahim Hassan Ahmed",
  "description": "Senior Quality Checker with 15 years of experience in tailoring"
}

### 1.3 - Verify Profile Updated
GET {{baseUrl}}/api/validator/profile
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 2: DASHBOARD & OVERVIEW
### ========================================

### 2.1 - Get Dashboard
GET {{baseUrl}}/api/validator/dashboard
Authorization: Bearer {{validatorToken}}

### 2.2 - Get All Tailors in Workshop
GET {{baseUrl}}/api/validator/tailors
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 3: ITEM ASSIGNMENT
### ========================================

### 3.1 - Get Order Details (to find items)
# Use order ID from SETUP-10, use validator token
GET {{baseUrl}}/api/orders/<orderId_from_setup10>
Authorization: Bearer {{validatorToken}}

### 3.2 - Assign First Item to Tailor
# Get first item ID from 3.1 response
# Set @itemId to first item ID
# Get @tailorId from SETUP-12 response
POST {{baseUrl}}/api/validator/items/{{itemId}}/assign
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "tailorId": {{tailorId}},
  "estimatedHours": 8,
  "notes": "High priority, customer wants quick turnaround"
}

### 3.3 - Assign Second Item to Tailor
POST {{baseUrl}}/api/validator/items/<second_itemId>/assign
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "tailorId": {{tailorId}},
  "estimatedHours": 6,
  "notes": "Standard priority"
}

### 3.4 - Get Validator Assignments
GET {{baseUrl}}/api/validator/assignments
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 4: WORKLOAD MONITORING
### ========================================

### 4.1 - Get Tailor Workload
# Using tailor ID from SETUP-12
GET {{baseUrl}}/api/validator/tailors/{{tailorId}}/workload
Authorization: Bearer {{validatorToken}}

### 4.2 - Check Workload After Assignments
GET {{baseUrl}}/api/validator/tailors/{{tailorId}}/workload
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 5: QUALITY CONTROL
### ========================================

### 5.1 - Simulate Item Completion (for testing)
# In real scenario, tailor would mark as completed
# For now, we'll test review with current item
# This should fail if item not COMPLETED
POST {{baseUrl}}/api/validator/items/{{itemId}}/review
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "approved": true,
  "feedback": "Excellent work, meets all specifications"
}

### 5.2 - Try Review on Non-Completed Item (Should Fail)
POST {{baseUrl}}/api/validator/items/{{itemId}}/review
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "approved": false,
  "feedback": "Needs more work on seams"
}

### ========================================
### PHASE 6: STATISTICS & REPORTING
### ========================================

### 6.1 - Get Validator Statistics
GET {{baseUrl}}/api/validator/statistics
Authorization: Bearer {{validatorToken}}

### 6.2 - Get Dashboard Again to See Updates
GET {{baseUrl}}/api/validator/dashboard
Authorization: Bearer {{validatorToken}}

### ========================================
### ERROR HANDLING TESTS
### ========================================

### E1 - Missing Required Fields in Assignment
POST {{baseUrl}}/api/validator/items/{{itemId}}/assign
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "tailorId": {{tailorId}}
}

### E2 - Assign Item to Non-Existent Tailor
POST {{baseUrl}}/api/validator/items/{{itemId}}/assign
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "tailorId": 99999,
  "estimatedHours": 8
}

### E3 - Assign Non-Existent Item
POST {{baseUrl}}/api/validator/items/99999/assign
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "tailorId": {{tailorId}},
  "estimatedHours": 8
}

### E4 - Get Non-Existent Tailor Workload
GET {{baseUrl}}/api/validator/tailors/99999/workload
Authorization: Bearer {{validatorToken}}

### E5 - Review Without Approved Field
POST {{baseUrl}}/api/validator/items/{{itemId}}/review
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "feedback": "Missing approval status"
}

### E6 - No Authorization
GET {{baseUrl}}/api/validator/profile

### E7 - Non-Validator Accessing Validator Endpoint
# Use magazine token
POST {{baseUrl}}/api/validator/items/{{itemId}}/assign
Authorization: Bearer <magazine_token>
Content-Type: application/json

{
  "tailorId": {{tailorId}},
  "estimatedHours": 8
}

### E8 - Invalid Assignment Data Type
POST {{baseUrl}}/api/validator/items/{{itemId}}/assign
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "tailorId": "not_a_number",
  "estimatedHours": "not_a_number"
}

### ========================================
### PERMISSION TESTS
### ========================================

### P1 - Non-Validator Cannot Get Dashboard
# Create non-validator user and try
GET {{baseUrl}}/api/validator/dashboard
Authorization: Bearer <magazine_token>

### P2 - Non-Validator Cannot Assign Items
POST {{baseUrl}}/api/validator/items/{{itemId}}/assign
Authorization: Bearer <magazine_token>
Content-Type: application/json

{
  "tailorId": {{tailorId}},
  "estimatedHours": 8
}

### P3 - Non-Validator Cannot Review Items
POST {{baseUrl}}/api/validator/items/{{itemId}}/review
Authorization: Bearer <magazine_token>
Content-Type: application/json

{
  "approved": true
}

### ========================================
### WORKFLOW GUIDE
### ========================================
###
### STEP 1: Run SETUP (SETUP-1 to SETUP-12)
### • Creates workshop, validator, tailor, magazine
### • Creates order with items
### • Validates order
### • Gets tailor list
###
### STEP 2: Profile (1.1 to 1.3)
### • Get profile
### • Update profile
### • Verify changes
###
### STEP 3: Dashboard (2.1 to 2.2)
### • View dashboard
### • See pending orders
### • List tailors
###
### STEP 4: Assignments (3.1 to 3.4)
### • View order items
### • Assign items to tailors
### • View all assignments
###
### STEP 5: Monitoring (4.1 to 4.2)
### • Check tailor workload
### • Monitor assignments
### • See estimated hours
###
### STEP 6: Quality (5.1 to 5.2)
### • Test item review
### • Approve items
### • Send for revision
###
### STEP 7: Statistics (6.1 to 6.2)
### • View performance stats
### • See dashboard updates
###
### STEP 8: Errors (E1 to E8)
### • Test missing data
### • Test non-existent resources
### • Test data validation
###
### STEP 9: Permissions (P1 to P3)
### • Test role-based access
### • Verify restrictions
### • Check security
###
### ========================================
### EXPECTED WORKFLOW
### ========================================
###
### 1. Validator logs in
### 2. Views dashboard (pending orders, tailors)
### 3. Looks at order details
### 4. Assigns items to appropriate tailors
### 5. Sets estimated hours for each item
### 6. Monitors tailor workloads
### 7. Reviews completed work
### 8. Approves or sends for revision
### 9. Tracks performance
###
### ========================================
### KEY VARIABLES
### ========================================
###
### @validatorToken = From SETUP-6 login
### @tailorId = From SETUP-12 tailor list
### @itemId = First item from order (SETUP-10)
###
### ========================================
### TOTAL TESTS: 30+
### ========================================
###
### Setup: 12
### Profile: 3
### Dashboard: 2
### Assignments: 4
### Monitoring: 2
### Quality: 2
### Statistics: 2
### Errors: 8
### Permissions: 3
###
### Total: 38+ comprehensive tests
###
### ========================================
