### ========================================
### SUBSCRIPTION & BILLING - HTTP TESTS
### ========================================
### Complete Subscription Management (MOCK PAYMENT)
### Base URL: http://localhost:3232
### ========================================

@baseUrl = http://localhost:3232
@workshopToken = 
@planId = beginner

### ========================================
### PHASE 0: SETUP
### ========================================
### Use existing workshop owner token from previous tests
### Set @workshopToken from authenticated workshop owner

### ========================================
### PHASE 1: BROWSE PLANS - 4 Tests
### ========================================

### 1.1 - Get All Available Plans
GET {{baseUrl}}/api/subscriptions/plans

### 1.2 - Verify Plans Returned
GET {{baseUrl}}/api/subscriptions/plans

### 1.3 - Get Beginner Plan Details
GET {{baseUrl}}/api/subscriptions/plans/beginner

### 1.4 - Get Professional Plan Details
GET {{baseUrl}}/api/subscriptions/plans/professional

### ========================================
### PHASE 2: PLAN DETAILS - 4 Tests
### ========================================

### 2.1 - Get Enterprise Plan Details
GET {{baseUrl}}/api/subscriptions/plans/enterprise

### 2.2 - Verify All Plan Details
GET {{baseUrl}}/api/subscriptions/plans/beginner

### 2.3 - Get Non-Existent Plan (Error)
GET {{baseUrl}}/api/subscriptions/plans/nonexistent

### 2.4 - Compare Plan Features
GET {{baseUrl}}/api/subscriptions/plans/professional

### ========================================
### PHASE 3: FIRST SUBSCRIPTION (MOCK PAYMENT) - 5 Tests
### ========================================

### 3.1 - Subscribe to Beginner Plan (FAKE PAYMENT)
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "beginner",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 3.2 - Try Subscribe Again (Should fail - already subscribed)
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "professional",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 3.3 - Get Current Subscription
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 3.4 - Verify Subscription Details
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 3.5 - Try Declining Payment (MOCK - 10% fail rate)
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "professional",
  "paymentMethodToken": "tok_mock_visa_decline_0002"
}

### ========================================
### PHASE 4: UPGRADE PLAN (MOCK PAYMENT) - 4 Tests
### ========================================

### 4.1 - Upgrade to Professional Plan
POST {{baseUrl}}/api/subscriptions/upgrade
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "newPlanId": "professional",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 4.2 - Verify Upgrade Applied
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 4.3 - Upgrade to Enterprise Plan
POST {{baseUrl}}/api/subscriptions/upgrade
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "newPlanId": "enterprise",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 4.4 - Verify Enterprise Plan Active
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### ========================================
### PHASE 5: SUBSCRIPTION HISTORY - 3 Tests
### ========================================

### 5.1 - Get Subscription History
GET {{baseUrl}}/api/subscriptions/history
Authorization: Bearer {{workshopToken}}

### 5.2 - Verify All Subscriptions Listed
GET {{baseUrl}}/api/subscriptions/history
Authorization: Bearer {{workshopToken}}

### 5.3 - Check History Count
GET {{baseUrl}}/api/subscriptions/history
Authorization: Bearer {{workshopToken}}

### ========================================
### PHASE 6: BILLING INFORMATION - 3 Tests
### ========================================

### 6.1 - Get Billing Information
GET {{baseUrl}}/api/subscriptions/billing
Authorization: Bearer {{workshopToken}}

### 6.2 - Verify Billing Details
GET {{baseUrl}}/api/subscriptions/billing
Authorization: Bearer {{workshopToken}}

### 6.3 - Check Monthly Amount
GET {{baseUrl}}/api/subscriptions/billing
Authorization: Bearer {{workshopToken}}

### ========================================
### PHASE 7: CANCELLATION - 3 Tests
### ========================================

### 7.1 - Cancel Current Subscription
POST {{baseUrl}}/api/subscriptions/cancel
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{}

### 7.2 - Verify Subscription Cancelled
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 7.3 - Try Cancel Again (Should Fail)
POST {{baseUrl}}/api/subscriptions/cancel
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{}

### ========================================
### PHASE 8: RESUBSCRIBE - 4 Tests
### ========================================

### 8.1 - Subscribe Again After Cancellation
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "professional",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 8.2 - Verify New Subscription
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 8.3 - Check Billing Info Updated
GET {{baseUrl}}/api/subscriptions/billing
Authorization: Bearer {{workshopToken}}

### 8.4 - Verify New History Entry
GET {{baseUrl}}/api/subscriptions/history
Authorization: Bearer {{workshopToken}}

### ========================================
### PHASE 9: ERROR HANDLING - 6 Tests
### ========================================

### E1 - Missing Authorization
GET {{baseUrl}}/api/subscriptions/current

### E2 - Invalid Token
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer invalid_token

### E3 - Missing Required Fields
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "beginner"
}

### E4 - Invalid Plan ID
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "invalid_plan",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### E5 - Get Details Non-Existent Plan
GET {{baseUrl}}/api/subscriptions/plans/nonexistent

### E6 - Upgrade Without Current Subscription
# Create new workshop owner first, then try upgrade
POST {{baseUrl}}/api/subscriptions/upgrade
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "newPlanId": "enterprise",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### ========================================
### PHASE 10: PAYMENT SCENARIOS (MOCK) - 5 Tests
### ========================================

### 10.1 - Successful Payment (90% rate)
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "beginner",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 10.2 - Failed Payment Simulation (10% rate)
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "professional",
  "paymentMethodToken": "tok_mock_visa_decline"
}

### 10.3 - Verify Successful Payment Applied
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 10.4 - Upgrade with Mock Payment
POST {{baseUrl}}/api/subscriptions/upgrade
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "newPlanId": "enterprise",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 10.5 - Verify Upgrade Payment Applied
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### ========================================
### PHASE 11: PLAN COMPARISON - 4 Tests
### ========================================

### 11.1 - Compare Beginner Features
GET {{baseUrl}}/api/subscriptions/plans/beginner

### 11.2 - Compare Professional Features
GET {{baseUrl}}/api/subscriptions/plans/professional

### 11.3 - Compare Enterprise Features
GET {{baseUrl}}/api/subscriptions/plans/enterprise

### 11.4 - Verify Feature Limits
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### ========================================
### PHASE 12: WORKFLOW TEST - 6 Tests
### ========================================

### 12.1 - Browse Plans
GET {{baseUrl}}/api/subscriptions/plans

### 12.2 - Check Beginner Details
GET {{baseUrl}}/api/subscriptions/plans/beginner

### 12.3 - Subscribe to Beginner
POST {{baseUrl}}/api/subscriptions/subscribe
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "planId": "beginner",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 12.4 - View Current Subscription
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 12.5 - Check Billing Details
GET {{baseUrl}}/api/subscriptions/billing
Authorization: Bearer {{workshopToken}}

### 12.6 - View History
GET {{baseUrl}}/api/subscriptions/history
Authorization: Bearer {{workshopToken}}

### ========================================
### PHASE 13: UPGRADE WORKFLOW - 4 Tests
### ========================================

### 13.1 - View Current Plan
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### 13.2 - Review Professional Plan
GET {{baseUrl}}/api/subscriptions/plans/professional

### 13.3 - Upgrade with Payment
POST {{baseUrl}}/api/subscriptions/upgrade
Authorization: Bearer {{workshopToken}}
Content-Type: application/json

{
  "newPlanId": "professional",
  "paymentMethodToken": "tok_mock_visa_success_4242"
}

### 13.4 - Verify Upgrade
GET {{baseUrl}}/api/subscriptions/current
Authorization: Bearer {{workshopToken}}

### ========================================
### EXECUTION GUIDE
### ========================================
###
### QUICK TEST (5 min):
### Run Phases 1-3 (13 tests)
### Browse plans and first subscription
###
### STANDARD TEST (10 min):
### Run Phases 1-7 (26 tests)
### Full subscription lifecycle
###
### COMPREHENSIVE TEST (20 min):
### Run all Phases 1-13 (52+ tests)
### All scenarios including mock payments
###
### ========================================
### MOCK PAYMENT DETAILS
### ========================================
###
### Payment Success:
### • Token: tok_mock_visa_success_4242
### • Simulated payment succeeds
### • Transaction ID generated
### • Subscription created
###
### Payment Failure:
### • Token: tok_mock_visa_decline_0002
### • Simulated decline
### • Returns 402 error
### • Subscription not created
###
### Success Rate:
### • 90% succeed
### • 10% fail
### • Randomized for testing
###
### NOTE:
### • No real payments processed
### • Testing ONLY
### • Fake transaction IDs
###
### ========================================
### PLAN OPTIONS
### ========================================
###
### Beginner:
### • $29.99/month
### • 3 magazines
### • 3 tailors
### • 50 orders
### • Email support
###
### Professional:
### • $99.99/month
### • 10 magazines
### • 10 tailors
### • 500 orders
### • Priority support
###
### Enterprise:
### • $299.99/month
### • Unlimited magazines
### • Unlimited tailors
### • 5000+ orders
### • 24/7 support
###
### ========================================
### SUBSCRIPTION STATUSES
### ========================================
###
### ACTIVE - Currently active
### CANCELLED - Cancelled by user
### EXPIRED - Subscription ended
### PENDING - Awaiting payment
###
### ========================================
