### ========================================
### ORDER MANAGEMENT - HTTP TESTS
### ========================================
### Complete Order Lifecycle Testing
### Base URL: http://localhost:3232
### ========================================

@baseUrl = http://localhost:3232
@workshopToken = 
@magazineToken = 
@validatorToken = 
@workshopId = 1
@orderId = 

### ========================================
### PHASE 0: SETUP - Create All Test Data
### ========================================
### Run these first to create necessary data

### SETUP-1: Register Workshop Owner
POST {{baseUrl}}/api/auth/register/workshop
Content-Type: application/json

{
  "username": "order_workshop_1",
  "password": "SecurePass123!",
  "email": "order_workshop@test.com",
  "firstname": "Ahmed",
  "lastname": "Mohamed",
  "workshopName": "Order Test Workshop",
  "workshopDescription": "Testing order management",
  "workshopAddress": "123 Test St",
  "phone": "+213600000001"
}

### SETUP-2: Get Validator Referral Link
# Use workshop token from SETUP-1 response
POST {{baseUrl}}/api/referral/validator
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTMsInVzZXJUeXBlIjoiV09SS1NIT1BfT1dORVIiLCJ3b3Jrc2hvcElkIjo5LCJpYXQiOjE3NjMxNTUzOTAsImV4cCI6MTc2NTc0NzM5MH0.oaxpGlEKJciWwdHorTyh9o-kSAh1NExk1P_wNEDUia4
Content-Type: application/json

{
  "expiresInDays": 30
}

### SETUP-3: Register Validator
# Use referral token from SETUP-2 response
POST {{baseUrl}}/api/auth/register/user
Content-Type: application/json

{
  "username": "validator_test_1",
  "password": "SecurePass123!",
  "email": "validator@test.com",
  "firstname": "Ibrahim",
  "lastname": "Hassan",
  "phone": "+213600000002",
  "userType": "VALIDATOR",
  "referralCode": "b796e58ab7ba9f6fee0f00c7bea4e314717abaecc52642c541a10337df757aa4"
}

### SETUP-4: Login Validator
# Copy accessToken and set @validatorToken
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "username": "validator_test_1",
  "password": "SecurePass123!"
}

### SETUP-5: Get Magazine Referral Link
# Use workshop token from SETUP-1
POST {{baseUrl}}/api/referral/magazine
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MTQsInVzZXJUeXBlIjoiVkFMSURBVE9SIiwidmFsaWRhdG9ySWQiOjIsIndvcmtzaG9wSWQiOjksImlhdCI6MTc2MzE1NTQ1MywiZXhwIjoxNzY1NzQ3NDUzfQ.yZwPelooQcQRmU3TJQQCv4XrWg9Gv3pyZbjZByLV4Xo
Content-Type: application/json

{
  "expiresInDays": 30
}

### SETUP-6: Register Magazine Owner
# Use referral token from SETUP-5 response
POST {{baseUrl}}/api/auth/register/user
Content-Type: application/json

{
  "username": "magazine_order_test_1",
  "password": "SecurePass123!",
  "email": "magazine_order@test.com",
  "firstname": "Fatima",
  "lastname": "Ali",
  "phone": "+213600000003",
  "userType": "MAGAZINE_OWNER",
  "referralCode": "<referral_token_from_setup5>"
}

### SETUP-7: Login Magazine Owner
# Copy accessToken and set @magazineToken
POST {{baseUrl}}/api/auth/login
Content-Type: application/json

{
  "username": "magazine_order_test_1",
  "password": "SecurePass123!"
}

### SETUP-8: Get Available Workshops
GET {{baseUrl}}/api/magazine/workshops
Authorization: Bearer {{magazineToken}}

### SETUP-9: Create First Order (PENDING)
# Note workshop ID from SETUP-8 response and set @workshopId
# Copy orderId from response and set @orderId
POST {{baseUrl}}/api/magazine/orders
Authorization: Bearer {{magazineToken}}
Content-Type: application/json

{
  "workshopId": {{workshopId}},
  "orderNumber": "ORD-TEST-001",
  "description": "10 women's formal dresses with embroidery",
  "estimatedCompletionDate": "2025-12-25T00:00:00Z",
  "totalPrice": 2500.00,
  "items": [
    {
      "description": "Red silk dress with gold embroidery"
    },
    {
      "description": "Blue cotton dress"
    }
  ]
}

### ========================================
### PHASE 1: VIEW ORDERS
### ========================================

### 1.1 - Get All Workshop Orders
GET {{baseUrl}}/api/orders/workshop
Authorization: Bearer {{validatorToken}}

### 1.2 - Get Pending Orders Only
GET {{baseUrl}}/api/orders/workshop?status=PENDING
Authorization: Bearer {{validatorToken}}

### 1.3 - Get Orders by Magazine
GET {{baseUrl}}/api/orders/workshop?magazineId=1
Authorization: Bearer {{validatorToken}}

### 1.4 - Get Specific Order Details
GET {{baseUrl}}/api/orders/{{orderId}}
Authorization: Bearer {{validatorToken}}

### 1.5 - Get Order Timeline (Before any changes)
GET {{baseUrl}}/api/orders/{{orderId}}/timeline
Authorization: Bearer {{validatorToken}}

### 1.6 - Get Order Statistics
GET {{baseUrl}}/api/orders/statistics/overview
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 2: VALIDATE ORDER
### ========================================

### 2.1 - Validate First Order (PENDING → VALIDATED)
POST {{baseUrl}}/api/orders/{{orderId}}/validate
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "notes": "Order validated successfully. All details verified."
}

### 2.2 - Verify Order is Validated
GET {{baseUrl}}/api/orders/{{orderId}}
Authorization: Bearer {{validatorToken}}

### 2.3 - Check Timeline After Validation
GET {{baseUrl}}/api/orders/{{orderId}}/timeline
Authorization: Bearer {{validatorToken}}

### 2.4 - Try to Validate Again (Should Fail)
POST {{baseUrl}}/api/orders/{{orderId}}/validate
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "notes": "This should fail"
}

### ========================================
### PHASE 3: TEST REJECTION
### ========================================

### 3.1 - Create Second Order for Rejection Test
POST {{baseUrl}}/api/magazine/orders
Authorization: Bearer {{magazineToken}}
Content-Type: application/json

{
  "workshopId": {{workshopId}},
  "orderNumber": "ORD-TEST-002",
  "description": "Order to be rejected",
  "totalPrice": 1000.00,
  "items": [
    {
      "description": "Test item"
    }
  ]
}

### 3.2 - Reject Second Order
# Get order ID from 3.1 response
POST {{baseUrl}}/api/orders/<orderId_from_3_1>/reject
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "rejectionReason": "Missing customer measurements and specific requirements"
}

### 3.3 - Check Timeline Shows Rejection
GET {{baseUrl}}/api/orders/<orderId_from_3_1>/timeline
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 4: STATUS TRANSITIONS
### ========================================

### 4.1 - Update Order to TAILORING
# Using first order from @orderId
PUT {{baseUrl}}/api/orders/{{orderId}}/status
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "newStatus": "TAILORING",
  "notes": "All items assigned to tailors. Work started."
}

### 4.2 - Verify Status is TAILORING
GET {{baseUrl}}/api/orders/{{orderId}}
Authorization: Bearer {{validatorToken}}

### 4.3 - Update Order to PACKAGING
PUT {{baseUrl}}/api/orders/{{orderId}}/status
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "newStatus": "PACKAGING",
  "notes": "All items completed. Now packaging for delivery."
}

### 4.4 - Verify Status is PACKAGING
GET {{baseUrl}}/api/orders/{{orderId}}
Authorization: Bearer {{validatorToken}}

### 4.5 - Update Order to COMPLETED
PUT {{baseUrl}}/api/orders/{{orderId}}/status
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "newStatus": "COMPLETED",
  "notes": "Order complete and ready for pickup"
}

### 4.6 - Verify Status is COMPLETED
GET {{baseUrl}}/api/orders/{{orderId}}
Authorization: Bearer {{validatorToken}}

### 4.7 - Get Complete Timeline
GET {{baseUrl}}/api/orders/{{orderId}}/timeline
Authorization: Bearer {{validatorToken}}

### ========================================
### PHASE 5: FILTERING & STATISTICS
### ========================================

### 5.1 - Get All Completed Orders
GET {{baseUrl}}/api/orders/workshop?status=COMPLETED
Authorization: Bearer {{validatorToken}}

### 5.2 - Get All Pending Orders (Should be empty or just rejected one)
GET {{baseUrl}}/api/orders/workshop?status=PENDING
Authorization: Bearer {{validatorToken}}

### 5.3 - Get Updated Statistics
GET {{baseUrl}}/api/orders/statistics/overview
Authorization: Bearer {{validatorToken}}

### ========================================
### ERROR HANDLING TESTS
### ========================================

### E1 - Invalid Status Transition (Backward)
PUT {{baseUrl}}/api/orders/{{orderId}}/status
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "newStatus": "PENDING"
}

### E2 - Skip Status (Go from TAILORING to COMPLETED)
# Create and validate a new order, move to TAILORING, then try COMPLETED
PUT {{baseUrl}}/api/orders/<new_order_id>/status
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "newStatus": "COMPLETED"
}

### E3 - Non-Existent Order
GET {{baseUrl}}/api/orders/99999
Authorization: Bearer {{validatorToken}}

### E4 - Non-Existent Order Update
PUT {{baseUrl}}/api/orders/99999/status
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "newStatus": "TAILORING"
}

### E5 - Reject Non-Existent Order
POST {{baseUrl}}/api/orders/99999/reject
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "rejectionReason": "Test rejection"
}

### E6 - Missing Rejection Reason
POST {{baseUrl}}/api/orders/{{orderId}}/reject
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
}

### E7 - Invalid Status in Update
PUT {{baseUrl}}/api/orders/{{orderId}}/status
Authorization: Bearer {{validatorToken}}
Content-Type: application/json

{
  "newStatus": "INVALID_STATUS"
}

### E8 - No Authorization
GET {{baseUrl}}/api/orders/workshop

### E9 - Non-Validator Accessing Validator-Only Endpoint
# Use magazine token instead of validator token
GET {{baseUrl}}/api/orders/workshop
Authorization: Bearer {{magazineToken}}

### ========================================
### PERMISSION TESTS
### ========================================

### P1 - Magazine Can View Order
GET {{baseUrl}}/api/orders/{{orderId}}
Authorization: Bearer {{magazineToken}}

### P2 - Magazine Can View Timeline
GET {{baseUrl}}/api/orders/{{orderId}}/timeline
Authorization: Bearer {{magazineToken}}

### P3 - Magazine Cannot Validate Orders
POST {{baseUrl}}/api/orders/{{orderId}}/validate
Authorization: Bearer {{magazineToken}}
Content-Type: application/json

{
  "notes": "Should fail"
}

### P4 - Magazine Cannot Update Status
PUT {{baseUrl}}/api/orders/{{orderId}}/status
Authorization: Bearer {{magazineToken}}
Content-Type: application/json

{
  "newStatus": "TAILORING"
}

### ========================================
### WORKFLOW GUIDE
### ========================================
###
### STEP 1: Run SETUP (SETUP-1 to SETUP-9)
### • Creates workshop, validator, magazine, order
### • Sets @validatorToken and @magazineToken
### • Creates first order in PENDING status
###
### STEP 2: Test Viewing (1.1 to 1.6)
### • View all orders
### • Filter by status
### • View specific order with items
### • Check timeline before changes
###
### STEP 3: Test Validation (2.1 to 2.4)
### • Validate pending order
### • Verify status changed
### • Check timeline updated
### • Try double validation (should fail)
###
### STEP 4: Test Rejection (3.1 to 3.3)
### • Create second order
### • Reject it
### • Verify rejection in timeline
###
### STEP 5: Test Status Transitions (4.1 to 4.7)
### • PENDING → TAILORING
### • TAILORING → PACKAGING
### • PACKAGING → COMPLETED
### • Check full timeline
###
### STEP 6: Test Filtering (5.1 to 5.3)
### • Filter by status
### • Get statistics
### • Verify counts
###
### STEP 7: Error Testing (E1 to E9)
### • Invalid transitions
### • Non-existent resources
### • Missing data
### • Auth errors
###
### STEP 8: Permission Testing (P1 to P4)
### • Magazine can view
### • Magazine cannot validate
### • Proper access control
###
### ========================================
### EXPECTED RESULTS
### ========================================
###
### Order Lifecycle:
### 1. Created in PENDING (by magazine)
### 2. Validated to VALIDATED (by validator)
### 3. Moved to TAILORING (by validator)
### 4. Moved to PACKAGING (by validator)
### 5. Moved to COMPLETED (by validator)
###
### Rejection Flow:
### 1. Order stays PENDING
### 2. Tracking logs rejection reason
### 3. Magazine can see rejection
### 4. Magazine can update and resubmit
###
### Timeline Entries:
### • One for each status transition
### • Who made the change
### • When it happened
### • Any notes provided
###
### ========================================
### KEY VARIABLES TO SET
### ========================================
###
### After SETUP-1 (Register Workshop):
### @workshopToken = <accessToken from response>
###
### After SETUP-4 (Login Validator):
### @validatorToken = <accessToken from response>
###
### After SETUP-7 (Login Magazine):
### @magazineToken = <accessToken from response>
###
### After SETUP-8 (Get Workshops):
### @workshopId = <id from first workshop>
###
### After SETUP-9 (Create Order):
### @orderId = <id from order response>
###
### ========================================
### TOTAL TESTS
### ========================================
###
### Setup Tests: 9
### Viewing Tests: 6
### Validation Tests: 4
### Rejection Tests: 3
### Status Tests: 7
### Filtering Tests: 3
### Error Tests: 9
### Permission Tests: 4
###
### TOTAL: 45+ comprehensive tests
###
### ========================================
